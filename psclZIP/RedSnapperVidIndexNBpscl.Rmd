
Red Snapper Video Index Using Delta GLM
========

This analysis generates a red snapper video index using a zero-inflated negative Binomial and Poisson model structure as implemented in the R package pscl.

```{r prelim,echo=FALSE,message=FALSE, warning=FALSE,error=FALSE}
rm(list=ls(all=TRUE)) 
graphics.off()
windows(record=T)
setwd ("\\\\CCFHR-S-1534090\\popdyn1\\SEDAR\\SEDAR 41\\SEFISIndices\\S41RGIT")
library(MASS)
library(doBy)
library(statmod)
library(Hmisc)
library(pscl)
library(lmtest)




```

```{r ReadData, echo=FALSE,message=FALSE, warning=FALSE,error=FALSE}
 # Read in Red Snapper Data
rs=read.csv("\\\\CCFHR-S-1534090\\popdyn1\\SEDAR\\SEDAR 41\\SEFISIndices\\ConfData\\RedSnapGLMData.csv")#;head(rs)
```

```{r ConditionData, echo=FALSE, message=FALSE, warning=FALSE}
# Full data subsetting: 
rs <- rs[rs$Station_Type!="Recon",]                # remove recon stations
rs <- rs[rs$A.Video.Readable == "Yes",]         # remove invalid videos
rs <- subset(rs, rs$Start_Depth > 0)                  # remove NA in depth
rs <- subset(rs, rs$Start_Depth < 100)              # remove < 100 m deep
rs <- subset(rs, rs$LastOfTemp > 0)                 # remove blank water temps
rs <- subset(rs, rs$Turbidity != "Unknown")    # remove unknown turbidity values
rs <- subset(rs, rs$No.Readable.Frames ==41)    # remove zero readable frames

#Eliminate unnecessary columns
dat=subset(rs,select=c(MC_Lutjanus.campechanus,No.Readable.Frames,Year,Turbidity,Current_Direction,Current_Magnitude,Substrate_Cat,Relief,Size,Biotic_Density_Cat,Biotic_Type,Biotic_Height,Start_Depth,Julian,Start_Latitude,LastOfTemp,TOD))
orgnames=names(dat)

sumcount=round(dat$MC_Lutjanus.campechanus*rs$No.Readable.Frames,0)
dat$MC_Lutjanus.campechanus=sumcount



#rename to short names
names(dat)=c('fishseen','frames','y','wc','cd','cm','sc','sr','ss','bd','bt','bh','d','t','lat','temp','tod')#;head(dat)

#replace NA in the cpue with 0
dat$fishseen[is.na(dat$fishseen)]=0

#rescale frames
#dat$frames=dat$frames/41
#dat$frames=log(dat$frames)
#now categorize the continuous variables
#depth
hist(dat$d,breaks=seq(10,110,by=5))
summary(dat$d)
#temp=cut(dat$d,breaks=c(14,25,41,52,115),labels=FALSE)#;temp;table(temp)
#temp=cut(dat$d,2,breaks=c(0,as.numeric(summary(dat$d))[-c(1,4)]),labels=FALSE);temp;table(temp)
temp=cut(dat$d,2,breaks=quantile(dat$d),labels=FALSE)#;temp;table(temp)
dat$d=temp

#latitude
hist(dat$lat,breaks=seq(27,36,by=0.25))
summary(dat$lat)
#temp=cut(dat$lat,breaks=c(27,29.75,31.25,32.75,34,35.25),labels=FALSE)#;temp;table(temp)
#temp=cut(dat$lat,2,breaks=c(0,as.numeric(summary(dat$lat))[-c(1,4)]),labels=FALSE);temp;table(temp)
temp=cut(dat$lat,2,breaks=quantile(dat$lat),labels=FALSE)#;temp;table(temp)
dat$lat=temp

#day of year (t)
hist(dat$t,breaks=seq(110,305,by=5))
summary(dat$t)
#temp=cut(dat$t,breaks=c(##,##,##,##,##,##),labels=FALSE)#;temp;table(temp)
#temp=cut(dat$t,2,breaks=c(0,as.numeric(summary(dat$t))[-c(1,4)]),labels=FALSE);temp;table(temp)
temp=cut(dat$t,2,breaks=quantile(dat$t),labels=FALSE)#;temp;table(temp)
dat$t=temp

#water temperature (temp)
hist(dat$temp,breaks=seq(12.25,29.25,by=0.25))
summary(dat$temp)
#temp=cut(dat$t,breaks=c(##,##,##,##,##,##),labels=FALSE)#;temp;table(temp)
#temp=cut(dat$temp,2,breaks=c(0,as.numeric(summary(dat$temp))[-c(1,4)]),labels=FALSE);temp;table(temp)
temp=cut(dat$temp,2,breaks=quantile(dat$temp),labels=FALSE)#;temp;table(temp)
dat$temp=temp

#time of day (tod)
hist(dat$tod,breaks=seq(0.4,0.95,by=0.025))
summary(dat$tod)
#temp=cut(dat$tod,breaks=c(##,##,##,##,##,##),labels=FALSE)#;temp;table(temp)
#temp=cut(dat$tod,2,breaks=c(0,as.numeric(summary(dat$tod))[-c(1,4)]),labels=FALSE);temp;table(temp)
temp=cut(dat$tod,2,breaks=quantile(dat$tod),labels=FALSE)#;temp;table(temp)
dat$tod=temp

#Factorize variables
dat$y=factor(dat$y)
dat$d=factor(dat$d)
dat$lat=factor(dat$lat)
dat$t=factor(dat$t)
dat$temp=factor(dat$temp)
dat$tod=factor(dat$tod)

#get rid of unused factors for dat$wc
dat$wc=factor(dat$wc)

plot.design(fishseen~y + wc + cd  ,data=dat)
plot.design(fishseen~ sc + bd ,data=dat)
plot.design(fishseen~d + t + lat + temp ,data=dat)


```

**So this bit evaluates the ZIP versus the ZINB **

The ZINB is clearly preferred in the likelihood ratio test and fits the data better.  But you can see that neither model fit the data particularly well.

```{r ZIP-ZINB, echo=T,message=T, warning=T}

zipform=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp )
zipmod=zeroinfl(zipform,  dist = "poisson", link = "logit",data=dat);summary(zipmod)

nbform=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp )
nbmod=zeroinfl(nbform,  dist = "negbin", link = "logit",data=dat);summary(nbmod)

lrtest(zipmod,nbmod)

windows(width=8,height=6,record=T)
resids=residuals(zipmod)
#cbind(fitted(zipmod),dat$fishseen,fitted(zipmod)-dat$fishseen,resids)
plot(fitted(zipmod),resids)
plot(dat$y,resids,xlab="Year",main="Residuals (zipmod)")
plot(dat$wc,resids,xlab="Water Clarity",main="Residuals (zipmod)")
plot(dat$cd,resids,xlab="Current Direction",main="Residuals (zipmod)")
plot(dat$bd,resids,xlab="Biotic Diversity",main="Residuals (zipmod)")
plot(dat$lat,resids,xlab="Latitude",main="Residuals (zipmod)")

plot(dat$fishseen,fitted(zipmod))

hist(dat$fishseen,breaks=0:max(dat$fishseen),freq=T,right=TRUE,xlab='Aggregate Fish Counted', main='ZIP')  
d=hist(predict(zipmod),breaks=0:max(dat$fishseen),plot=FALSE)
lines(seq(0.5,max(dat$fishseen),by=1),d$counts, col="blue",type='l')      
hist(dat$fishseen,breaks=0:max(dat$fishseen),freq=T,right=TRUE,xlab='Aggregate Fish Counted', main='ZIP',ylim=c(0,50))  
lines(seq(0.5,max(dat$fishseen),by=1),d$counts, col="blue",type='b')      


windows(width=8,height=6,record=T)
resids=residuals(nbmod)
#cbind(fitted(nbmod),dat$fishseen,fitted(nbmod)-dat$fishseen,resids)
plot(fitted(nbmod),resids)
plot(dat$fishseen,fitted(nbmod))

plot(dat$y,resids,xlab="Year",main="Residuals (nbmod)")
plot(dat$wc,resids,xlab="Water Clarity",main="Residuals (nbmod)")
plot(dat$cd,resids,xlab="Current Direction",main="Residuals (nbmod)")
plot(dat$bd,resids,xlab="Biotic Diversity",main="Residuals (nbmod)")
plot(dat$lat,resids,xlab="Latitude",main="Residuals (nbmod)")

hist(dat$fishseen,breaks=0:max(dat$fishseen),freq=T,right=TRUE,xlab='Aggregate Fish Counted', main='NB')  
d2=hist(predict(nbmod),breaks=0:max(dat$fishseen),plot=FALSE)
lines(seq(0.5,max(dat$fishseen),by=1),d2$counts, col="blue",type='l')      
hist(dat$fishseen,breaks=0:max(dat$fishseen),freq=T,right=TRUE,xlab='Aggregate Fish Counted', main='NB',ylim=c(0,50))  
lines(seq(0.5,max(dat$fishseen),by=1),d2$counts, col="blue",type='b')      

plot(dat$fishseen,fitted(nbmod))
points(dat$fishseen,fitted(zipmod),col='red',pch=19)


```


**So this bit allows variable selection within the ZINB**

```{r ZINB VarSel, echo=F,message=T, warning=T}


###Remove water clarity and current variables from mean
nbform1=formula(fishseen~ y  + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod1=zeroinfl(nbform1,  dist = "negbin", link = "logit",data=dat);summary(nbmod1)

nbform2=formula(fishseen~ y  + wc + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod2=zeroinfl(nbform2,  dist = "negbin", link = "logit",data=dat);summary(nbmod2)


###Remove benthic variables from mean
nbform3=formula(fishseen~ y + wc + cd + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod3=zeroinfl(nbform3,  dist = "negbin", link = "logit",data=dat);summary(nbmod3)

nbform4=formula(fishseen~ y + wc + cd + sc + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod4=zeroinfl(nbform4,  dist = "negbin", link = "logit",data=dat);summary(nbmod4)

###Remove depth from mean
nbform5=formula(fishseen~ y + wc + cd + sc + bd + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod5=zeroinfl(nbform5,  dist = "negbin", link = "logit",data=dat);summary(nbmod5)

#### Remove Season From mean 
nbform6=formula(fishseen~ y + wc + cd + sc + bd + d + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod6=zeroinfl(nbform6,  dist = "negbin", link = "logit",data=dat);summary(nbmod6)

#### Remove Latitude From mean 
nbform7=formula(fishseen~ y + wc + cd + sc + bd + d + t + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod7=zeroinfl(nbform7,  dist = "negbin", link = "logit",data=dat);summary(nbmod7)

#### Remove Temperature From mean 
nbform8=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat  +offset(frames)|y + wc + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod8=zeroinfl(nbform8,  dist = "negbin", link = "logit",data=dat);summary(nbmod8)

lrtest(nbmod1,nbmod)
lrtest(nbmod2,nbmod)
lrtest(nbmod3,nbmod)
lrtest(nbmod4,nbmod)
lrtest(nbmod5,nbmod)
lrtest(nbmod6,nbmod)
lrtest(nbmod7,nbmod)
lrtest(nbmod8,nbmod)
AIC(nbmod)
AIC(nbmod1)
AIC(nbmod2)
AIC(nbmod3)
AIC(nbmod4)
AIC(nbmod5)
AIC(nbmod6)
AIC(nbmod7)
AIC(nbmod8)
AIC(nbmod)-AIC(nbmod1)
AIC(nbmod)-AIC(nbmod2)
AIC(nbmod)-AIC(nbmod3)
AIC(nbmod)-AIC(nbmod4)
AIC(nbmod)-AIC(nbmod5)
AIC(nbmod)-AIC(nbmod6)
AIC(nbmod)-AIC(nbmod7)
AIC(nbmod)-AIC(nbmod8)

####Retain All variables for the count... clarity and temperature were marginal


##Now conduct variable selection on the binomial part
###Remove water clarity and current variables from mean
nbform1=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + cd + sc + bd + d + t + lat + temp +offset(frames))
nbmod1=zeroinfl(nbform1,  dist = "negbin", link = "logit",data=dat);summary(nbmod1)

nbform2=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + sc + bd + d + t + lat + temp +offset(frames))
nbmod2=zeroinfl(nbform2,  dist = "negbin", link = "logit",data=dat);summary(nbmod2)


###Remove benthic variables from mean
nbform3=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + bd + d + t + lat + temp +offset(frames))
nbmod3=zeroinfl(nbform3,  dist = "negbin", link = "logit",data=dat);summary(nbmod3)

nbform4=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + d + t + lat + temp +offset(frames))
nbmod4=zeroinfl(nbform4,  dist = "negbin", link = "logit",data=dat);summary(nbmod4)

###Remove depth from mean
nbform5=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + t + lat + temp +offset(frames))
nbmod5=zeroinfl(nbform5,  dist = "negbin", link = "logit",data=dat);summary(nbmod5)

#### Remove Season From mean 
nbform6=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + lat + temp +offset(frames))
nbmod6=zeroinfl(nbform6,  dist = "negbin", link = "logit",data=dat);summary(nbmod6)

#### Remove Latitude From mean 
nbform7=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + temp +offset(frames))
nbmod7=zeroinfl(nbform7,  dist = "negbin", link = "logit",data=dat);summary(nbmod7)

#### Remove Temperature From mean 
nbform8=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + bd + d + t + lat +offset(frames))
nbmod8=zeroinfl(nbform8,  dist = "negbin", link = "logit",data=dat);summary(nbmod8)

lrtest(nbmod1,nbmod)
lrtest(nbmod2,nbmod)
lrtest(nbmod3,nbmod)
lrtest(nbmod4,nbmod)
lrtest(nbmod5,nbmod)
lrtest(nbmod6,nbmod)
lrtest(nbmod7,nbmod)
lrtest(nbmod8,nbmod)
AIC(nbmod)
AIC(nbmod1)
AIC(nbmod2)
AIC(nbmod3)
AIC(nbmod4)
AIC(nbmod5)
AIC(nbmod6)
AIC(nbmod7)
AIC(nbmod8)
AIC(nbmod)-AIC(nbmod1)
AIC(nbmod)-AIC(nbmod2)
AIC(nbmod)-AIC(nbmod3)
AIC(nbmod)-AIC(nbmod4)
AIC(nbmod)-AIC(nbmod5)
AIC(nbmod)-AIC(nbmod6)
AIC(nbmod)-AIC(nbmod7)
AIC(nbmod)-AIC(nbmod8)


##Start with nbform4 which has bd removed##
###Remove water clarity and current variables from mean
nbform4a=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + cd + sc + d + t + lat + temp +offset(frames))
nbmod4a=zeroinfl(nbform4a,  dist = "negbin", link = "logit",data=dat);summary(nbmod4a)

nbform4b=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + sc + d + t + lat + temp +offset(frames))
nbmod4b=zeroinfl(nbform4b,  dist = "negbin", link = "logit",data=dat);summary(nbmod4b)


###Remove benthic variables from mean
nbform4c=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + d + t + lat + temp +offset(frames))
nbmod4c=zeroinfl(nbform4c,  dist = "negbin", link = "logit",data=dat);summary(nbmod4c)


###Remove depth from mean
nbform4d=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc +t + lat + temp +offset(frames))
nbmod4d=zeroinfl(nbform4d,  dist = "negbin", link = "logit",data=dat);summary(nbmod4d)

#### Remove Season From mean 
nbform4e=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + d +lat + temp +offset(frames))
nbmod4e=zeroinfl(nbform4e,  dist = "negbin", link = "logit",data=dat);summary(nbmod4e)

#### Remove Latitude From mean 
nbform4f=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + d + t + temp +offset(frames))
nbmod4f=zeroinfl(nbform4f,  dist = "negbin", link = "logit",data=dat);summary(nbmod4f)

#### Remove Temperature From mean 
nbform4g=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + cd + sc + d + t + lat +offset(frames))
nbmod4g=zeroinfl(nbform4g,  dist = "negbin", link = "logit",data=dat);summary(nbmod4g)

lrtest(nbmod4a,nbmod4)
lrtest(nbmod4b,nbmod4)
lrtest(nbmod4c,nbmod4)
lrtest(nbmod4d,nbmod4)
lrtest(nbmod4e,nbmod4)
lrtest(nbmod4f,nbmod4)
lrtest(nbmod4g,nbmod4)
AIC(nbmod4)
AIC(nbmod4a)
AIC(nbmod4b)
AIC(nbmod4c)
AIC(nbmod4d)
AIC(nbmod4e)
AIC(nbmod4f)
AIC(nbmod4g)
AIC(nbmod4)-AIC(nbmod4a)
AIC(nbmod4)-AIC(nbmod4b)
AIC(nbmod4)-AIC(nbmod4c)
AIC(nbmod4)-AIC(nbmod4d)
AIC(nbmod4)-AIC(nbmod4e)
AIC(nbmod4)-AIC(nbmod4f)
AIC(nbmod4)-AIC(nbmod4g)


##Start with nbform4b which has bd removed##
###Remove water clarity  from mean
nbform4b1=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + sc + d + t + lat + temp +offset(frames))
nbmod4b1=zeroinfl(nbform4b1,  dist = "negbin", link = "logit",data=dat);summary(nbmod4b1)


###Remove benthic variables from mean
nbform4b2=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + d + t + lat + temp +offset(frames))
nbmod4b2=zeroinfl(nbform4b2,  dist = "negbin", link = "logit",data=dat);summary(nbmod4b2)


###Remove depth from mean
nbform4b3=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + sc + t + lat + temp +offset(frames))
nbmod4b3=zeroinfl(nbform4b3,  dist = "negbin", link = "logit",data=dat);summary(nbmod4b3)

#### Remove Season From mean 
nbform4b4=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + sc + d + lat + temp +offset(frames))
nbmod4b4=zeroinfl(nbform4b4,  dist = "negbin", link = "logit",data=dat);summary(nbmod4b4)

#### Remove Latitude From mean 
nbform4b5=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + sc + d + t + temp +offset(frames))
nbmod4b5=zeroinfl(nbform4b5,  dist = "negbin", link = "logit",data=dat);summary(nbmod4b5)

#### Remove Temperature From mean 
nbform4b6=formula(fishseen~ y + wc + cd + sc + bd + d + t + lat + temp +offset(frames)|y + wc + sc + d + t + lat + offset(frames))
nbmod4b6=zeroinfl(nbform4b6,  dist = "negbin", link = "logit",data=dat);summary(nbmod4b6)

lrtest(nbmod4b1,nbmod4b)
lrtest(nbmod4b2,nbmod4b)
lrtest(nbmod4b3,nbmod4b)
lrtest(nbmod4b4,nbmod4b)
lrtest(nbmod4b5,nbmod4b)
lrtest(nbmod4b6,nbmod4b)
AIC(nbmod4b)
AIC(nbmod4b1)
AIC(nbmod4b2)
AIC(nbmod4b3)
AIC(nbmod4b4)
AIC(nbmod4b5)
AIC(nbmod4b6)
AIC(nbmod4b)-AIC(nbmod4b1)
AIC(nbmod4b)-AIC(nbmod4b2)
AIC(nbmod4b)-AIC(nbmod4b3)
AIC(nbmod4b)-AIC(nbmod4b4)
AIC(nbmod4b)-AIC(nbmod4b5)
AIC(nbmod4b)-AIC(nbmod4b6)


#nbmod4b is best
nbbest=nbmod4b

windows(width=8,height=6,record=T)
resids=residuals(nbbest)
#cbind(fitted(nbbest),dat$fishseen,fitted(nbbest)-dat$fishseen,resids)
plot(fitted(nbbest),resids)
plot(dat$fishseen,fitted(nbbest))

plot(dat$y,resids,xlab="Year",main="Residuals (nbbest)")
plot(dat$wc,resids,xlab="Water Clarity",main="Residuals (nbbest)")
plot(dat$cd,resids,xlab="Current Direction",main="Residuals (nbbest)")
plot(dat$sc,resids,xlab="Substrate Composition",main="Residuals (nbbest)")
plot(dat$bd,resids,xlab="Biotic Diversity",main="Residuals (nbbest)")
plot(dat$d,resids,xlab="Depth",main="Residuals (nbbest)")
plot(dat$t,resids,xlab="Season",main="Residuals (nbbest)")
plot(dat$lat,resids,xlab="Latitude",main="Residuals (nbbest)")
plot(dat$temp,resids,xlab="Water Temperature",main="Residuals (nbbest)")

hist(dat$fishseen,breaks=0:max(dat$fishseen),freq=T,right=TRUE,xlab='Aggregate Fish Counted', main='NB')  
d3=hist(predict(nbbest),breaks=0:max(dat$fishseen),plot=FALSE)
lines(seq(0.5,max(dat$fishseen),by=1),d3$counts, col="blue",type='l')      
hist(dat$fishseen,breaks=0:max(dat$fishseen),freq=T,right=TRUE,xlab='Aggregate Fish Counted', main='NB',ylim=c(0,50))  
lines(seq(0.5,max(dat$fishseen),by=1),d3$counts, col="blue",type='l')      
#lines(seq(0.5,max(dat$fishseen),by=1),d2$counts, col="red",type='l')      
#lines(seq(0.5,max(dat$fishseen),by=1),d$counts, col="green",type='l')      


new.dat=expand.grid(y=levels(dat$y),
                    wc=levels(dat$wc),
                    #cm=levels(dat$cm),
                    cd=levels(dat$cd),
                    sc=levels(dat$sc),
                    bd=levels(dat$bd),
                    #bt=levels(dat$bt),
                    #bh=levels(dat$bh),
                    d=levels(dat$d),
                    t=levels(dat$t),
                    lat=levels(dat$lat),
                    temp=levels(dat$temp),
                    tod=levels(dat$tod),
                    frames=1)

new.dat=cbind(new.dat,predict(nbbest,new.dat))
names(new.dat)[dim(new.dat)[2]]="Predicted"
resvec=summaryBy(Predicted~y,data=new.dat,FUN=mean)[,2]
index = resvec/mean(resvec)
index = resvec/max(resvec)

plot(index,type='b')

